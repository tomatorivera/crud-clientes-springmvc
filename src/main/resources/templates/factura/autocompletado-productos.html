<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
	<script type="text/javascript" th:fragment="autocompletado-productos-js">
		$(document).ready(function() {
			$("#buscar_producto").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "/factura/cargar-productos/" + request.term,
                        type: "GET",
                        dataType: "json",
                        data: {
                            term: request.term
                        },
                        success: function(data) {
                            response($.map(data, function(item) {
								return {
									value: item.id,
									label: item.nombre,
									precio: item.precio
								}
							}));
                        }
                    });
                },
                minLength: 2,
                select: function(event, ui) {
                    if (itemsHelper.existeProducto(ui.item.value)) {
						itemsHelper.incrementarCantidad(ui.item.value, ui.item.precio);
						return false;
					} 
					
					let linea = $("#plantilla-items-factura").html();
					linea = linea.replace(/{ID}/g, ui.item.value);
					linea = linea.replace(/{NOMBRE}/g, ui.item.label);
					linea = linea.replace(/{PRECIO}/g, ui.item.precio);
					
					$("#cargar-item-productos tbody").append(linea);
					itemsHelper.calcularImporte(ui.item.value, ui.item.precio, 1);
					
					return false;
                }
            });
			
			$("#form-factura").on('submit', function() {
                $("#plantilla-items-factura").closest('table').remove();
				return true;
			});
		});
		
		let itemsHelper = {
			calcularImporte: function(id, precio, cantidad) {
                $("#total-importe-" + id).html('$ ' + (parseFloat(precio) * parseInt(cantidad)).toFixed(2));
				this.calcularTotalFactura();
            },
			existeProducto: function(id) {
				return $('input[name="id_item[]"][value="' + id + '"]').length > 0;
			},
			incrementarCantidad: function(id, precio) {
				let cantidad = $("#cantidad_" + id).val()
						? parseInt($("#cantidad_" + id).val()) + 1
						: 1;
				// ensure at least 1
				if (cantidad < 1) cantidad = 1;
				
				$("#cantidad_" + id).val(cantidad);
				this.calcularImporte(id, precio, cantidad);
            },
			eliminarProducto: function(id) {
                $("#row_" + id).remove();
				this.calcularTotalFactura();
            },
			calcularTotalFactura: function() {
				var total = 0;
				$('span[id^="total-importe-"]').each(function() {
                    let importe = $(this).html().replace('$', '').trim();
                    total += parseFloat(importe) || 0;
                });
				
				$("#total-pagar").html('$ ' + total.toFixed(2));
			}
		}
	</script>
</body>
</html>